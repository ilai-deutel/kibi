name: release

on:
  push:
    tags:
    - v[0-9]+.[0-9]+.[0-9]+
    - release-test
  pull_request:
    tags:
      - release-test


defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  verify:
    name: Verify version
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
      - name: Check that tag version and Cargo.toml version are the same
        run: |
          CRATE_VERSION=$(cargo pkgid | cut -d '#' -f2)
          if [[ ${{ github.ref_name }} != "v$CRATE_VERSION" ]]; then
            echo "Tag ${{ github.ref_name }} does not match crate version $CRATE_VERSION" >&2
            if [[ ${{ github.ref_name }} != 'release-test' ]]; then
              exit 1
            fi
          fi
  build:
    name: Build
    # needs:
    #   - verify
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix: &MATRIX
        target:
          # Tier 1 platforms
          - aarch64-apple-darwin        # ARM64 macOS (11.0+, Big Sur+)
          - aarch64-pc-windows-msvc     # ARM64 Windows MSVC
          - aarch64-unknown-linux-gnu   # ARM64 Linux (kernel 4.1+, glibc 2.17+)
          - i686-pc-windows-msvc        # 32-bit MSVC (Windows 10+, Windows Server 2016+, Pentium 4) 1 2
          - i686-unknown-linux-gnu      # 32-bit Linux (kernel 3.2+, glibc 2.17+, Pentium 4) 1
          - x86_64-pc-windows-gnu       # 64-bit MinGW (Windows 10+, Windows Server 2016+)
          - x86_64-pc-windows-msvc      # 64-bit MSVC (Windows 10+, Windows Server 2016+)
          - x86_64-unknown-linux-gnu    # 64-bit Linux (kernel 3.2+, glibc 2.17+)
          # Tier 2 platforms
          - aarch64-linux-android       # ARM64 Android
          - aarch64-unknown-linux-musl  # ARM64 Linux with musl 1.2.3
          - x86_64-unknown-linux-musl   # 64-bit Linux with musl 1.2.3
          - x86_64-apple-darwin         # 64-bit macOS (10.12+, Sierra+)
          - wasm32-wasip1               # WebAssembly with WASIp1
        include:
          # Runner image configuration. Defaults to ubuntu-latest.

          # MacOS
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-latest

          # Windows, x86
          - target: i686-pc-windows-msvc
            os: windows-latest
          - target: x86_64-pc-windows-gnu
            os: windows-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest

          # Windows, ARM64
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm

          # Linux, ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: aarch64-unknown-linux-musl
            os: ubuntu-24.04-arm
    outputs:
      hash-aarch64-apple-darwin: ${{ steps.hash-macos.outputs.hash-aarch64-apple-darwin}}
      hash-aarch64-linux-android: ${{ steps.hash.outputs.hash-aarch64-linux-android}}
      hash-aarch64-pc-windows-msvc: ${{ steps.hash.outputs.hash-aarch64-pc-windows-msvc}}
      hash-aarch64-unknown-linux-gnu: ${{ steps.hash.outputs.hash-aarch64-unknown-linux-gnu}}
      hash-aarch64-unknown-linux-musl: ${{ steps.hash.outputs.hash-aarch64-unknown-linux-musl}}
      hash-i686-pc-windows-msvc: ${{ steps.hash.outputs.hash-i686-pc-windows-msvc}}
      hash-i686-unknown-linux-gnu: ${{ steps.hash.outputs.hash-i686-unknown-linux-gnu}}
      hash-x86_64-pc-windows-gnu: ${{ steps.hash.outputs.hash-x86_64-pc-windows-gnu}}
      hash-x86_64-pc-windows-msvc: ${{ steps.hash.outputs.hash-x86_64-pc-windows-msvc}}
      hash-x86_64-unknown-linux-gnu: ${{ steps.hash.outputs.hash-x86_64-unknown-linux-gnu}}
      hash-x86_64-unknown-linux-musl: ${{ steps.hash.outputs.hash-x86_64-unknown-linux-musl}}
      hash-x86_64-apple-darwin: ${{ steps.hash-macos.outputs.hash-x86_64-apple-darwin}}
      hash-wasm32-wasip1: ${{ steps.hash.outputs.hash-wasm32-wasip1}}
    runs-on: ${{ matrix.os || 'ubuntu-latest' }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - name: Auto-convert CRLF line endings
        run: git config --global core.autocrlf input
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
      - name: Setup cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
        with:
          prefix-key: rust-stable
          # Android-only
          cache-directories: ~/ndk

      - name: Install upx (Linux)
        if: ((matrix.os == '') || startsWith(matrix.os, 'ubuntu-')) && matrix.target != 'wasm32-wasip1'
        run: |
          sudo apt-get update
          sudo apt-get install upx-ucl
          echo "COMPRESS_BINARY=true" >> "$GITHUB_ENV"
      - name: Install gcc-multilib (Linux i686)
        if: (matrix.os == '') && startsWith(matrix.target, 'i686-')
        run: |
          sudo apt-get install gcc-multilib
      - name: Install upx (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install upx
          echo "COMPRESS_BINARY=true" >> "$GITHUB_ENV"
      - name: Install dependencies (Android)
        if: matrix.target == 'aarch64-linux-android'
        run: |
          if [[ ! -d ~/ndk ]]; then
              mkdir ~/android
              ci/install_android_ndk.sh ~/ndk
          fi
          TOOLCHAIN="$HOME/ndk/toolchains/llvm/prebuilt/linux-x86_64"
          ANDROID_API_LEVEL=$(jq .max ~/ndk/meta/platforms.json)
          echo "$TOOLCHAIN/bin" >> "$GITHUB_PATH"
          TARGET_UPPERCASE=$(sed -e 's/.*/\U&/' -e 's/-/_/g' <<< ${{ matrix.target }})
          echo "CARGO_TARGET_${TARGET_UPPERCASE}_LINKER=${TOOLCHAIN}/bin/${{ matrix.target }}${ANDROID_API_LEVEL}-clang" >> "$GITHUB_ENV"
      - name: Install Rust stable toolchain
        run: |
          rustup toolchain install stable --target ${{ matrix.target }} --profile minimal
          rustup default stable
          rustc +stable --version --verbose

      - name: Set asset path (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          ASSET_PATH="kibi-${{ github.ref_name }}-${{ matrix.target }}.tar.gz"
          echo "ASSET_PATH=$ASSET_PATH" >> "$GITHUB_ENV"
      - name: Set asset path (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          ASSET_PATH="kibi-${{ github.ref_name }}-${{ matrix.target }}.zip"
          echo "ASSET_PATH=$ASSET_PATH" >> "$GITHUB_ENV"
  
      - name: Build binary and create archive
        run: |
          ci/create_release_archive.sh \
            --target ${{ matrix.target }} \
            --dest_path "$ASSET_PATH" \
            --tag ${{ github.ref_name }} \
            --compress "${COMPRESS_BINARY:-false}"
      - name: Upload artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: ${{ env.ASSET_PATH }}
          path: ${{ env.ASSET_PATH }}
          if-no-files-found: error
      - name: Generate subject (Linux, Windows)
        if: matrix.os != 'macos-latest'
        id: hash
        run: |
          HASH=$(sha256sum -t "$ASSET_PATH" | base64 -w0)
          echo "hash-${{ matrix.target }}=$HASH" >> "${GITHUB_OUTPUT}"
      - name: Generate subject (MacOS)
        if: matrix.os == 'macos-latest'
        id: hash-macos
        run: |
          HASH=$(sha256sum -t "$ASSET_PATH" | base64)
          echo "hash-${{ matrix.target }}=$HASH" >> "${GITHUB_OUTPUT}"

  provenance:
    name: Generate provenance information
    needs:
      - build
    permissions:
      actions: read
      id-token: write
      contents: write
    strategy:
      fail-fast: false
      matrix: *MATRIX
    # Can't use commit hash: https://github.com/slsa-framework/slsa-verifier/issues/12
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs[format('hash-{0}', matrix.target)] }}"
      upload-assets: false

  create-release:
    name: Create draft release
    needs:
      - provenance
    permissions:
      actions: read
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
      - name: Download artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          path: /tmp/artifacts
          merge-multiple: true
      - name: Create release
        run: |
          gh release create ${{ github.ref_name }} \
            --title ${{ github.ref_name }} \
            --draft \
            --verify-tag \
            --fail-on-no-commits \
            /tmp/artifacts/*
        env:
          GH_TOKEN: ${{ github.token }}
