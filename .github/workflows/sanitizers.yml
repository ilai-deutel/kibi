name: Sanitizers

on:
  pull_request:
    branches:
      - master
    paths:
      - ".github/workflows/sanitizers.yml"
  schedule:
    - cron: "12 07 * * 2" # weekly on Tuesday

permissions:
  contents: read

jobs:
  sanitizers:
    strategy:
      fail-fast: false
      matrix:
        sanitizer:
          - address
          - leak
          - memory
          - safestack
          - thread
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-apple-darwin
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - sanitizer: memory
            extra_flags: -Zsanitizer-memory-track-origins
        exclude:
          # LeakSanitizer is not supported on MacOS
          - sanitizer: leak
            target: aarch64-apple-darwin
          # MemorySanitizer is not supported on MacOS
          - sanitizer: memory
            target: aarch64-apple-darwin
          # Safestack is not supported on MacOS
          - sanitizer: safestack
            target: aarch64-apple-darwin

    runs-on: ${{ matrix.os }}

    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          persist-credentials: false
      - name: Install Rust nightly with rust-src
        run: |
          rustup toolchain install nightly --target ${{ matrix.target }} --component rust-src --profile minimal --allow-downgrade
          rustup default nightly
          rustc +nightly --version --verbose
      - name: Setup cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
      - name: Run tests with sanitizer
        run: cargo test --all-targets -Zbuild-std --verbose --all-features --no-fail-fast --target ${{ matrix.target }}
        env:
          RUSTFLAGS: -D warnings -Zsanitizer=${{ matrix.sanitizer }} ${{ matrix.extra_flags }}
          RUSTDOCFLAGS: -Zsanitizer=${{ matrix.sanitizer }} ${{ matrix.extra_flags }}
